# 🎵 AI 音乐服务 - 准备部署说明

## ✅ 已完成的配置工作

我已经帮你完成了以下配置：

### 1. 环境变量配置 (.env)
- ✅ 移除了文件服务器相关配置（音乐服务不需要）
- ✅ 配置了正确的端口 (3001)
- ✅ 配置了 OSS 签名 URL 接口
- ✅ 配置了任务管理器参数

### 2. PM2 配置 (ecosystem.config.js)
- ✅ 移除了 file-server 进程配置
- ✅ 只保留了主服务进程 (ai-music-service)
- ✅ 优化了内存和重启策略

### 3. package.json
- ✅ 移除了文件服务器相关脚本
- ✅ 保留了必要的 PM2 管理脚本

### 4. 文件清理
- ✅ 将 file-server.js 重命名为 file-server.js.backup（不会被部署）

### 5. 部署脚本
- ✅ 创建了一键部署脚本 (一键部署.sh)
- ✅ 创建了部署前检查脚本 (部署前检查.sh)
- ✅ 创建了 Windows 打包脚本 (打包部署.bat)

### 6. 文档
- ✅ 部署到服务器指南.md - 详细的部署步骤
- ✅ 服务配置对比说明.md - 与视频服务的区别
- ✅ 部署配置总结.md - 配置汇总

---

## 🚀 现在可以开始部署了！

### 方式一：使用打包脚本（推荐）

#### 1. 在本地打包
```bash
# Windows
双击运行: 打包部署.bat

# 会生成: ai-music-service-YYYYMMDD_HHMMSS.zip
```

#### 2. 上传到服务器
```bash
scp ai-music-service-*.zip root@47.252.36.81:/opt/
```

#### 3. 在服务器上部署
```bash
ssh root@47.252.36.81

# 解压
cd /opt
unzip ai-music-service-*.zip -d ai-music-service
cd ai-music-service

# 检查配置
cat .env

# 运行部署前检查
chmod +x 部署前检查.sh
./部署前检查.sh

# 一键部署
chmod +x 一键部署.sh
./一键部署.sh
```

---

### 方式二：直接拷贝整个目录

#### 1. 使用 rsync 或 scp 上传
```bash
# 使用 rsync（推荐）
rsync -avz --exclude='node_modules' \
  --exclude='logs' \
  --exclude='temp_audio' \
  --exclude='uploads' \
  --exclude='test-*.js' \
  --exclude='*.backup' \
  C:\work\ai_music\ai_music_service_deploy/ \
  root@47.252.36.81:/opt/ai-music-service/
```

#### 2. 在服务器上部署
```bash
ssh root@47.252.36.81
cd /opt/ai-music-service

# 运行一键部署
chmod +x 一键部署.sh
./一键部署.sh
```

---

## 📋 部署前检查清单

在部署前，请确认：

### 服务器环境
- [ ] 服务器 IP: 47.252.36.81
- [ ] 已安装 Node.js >= 18.0.0
- [ ] 已安装 PM2 或准备安装
- [ ] 端口 3001 未被占用
- [ ] 防火墙已开放 3001 端口

### 配置文件
- [ ] .env 文件中的 SERVER_IP 正确
- [ ] .env 文件中的 SUNO_API_KEY 正确
- [ ] .env 文件中的 OSS_SIGNED_URL_API 正确
- [ ] .env 文件中的 PORT=3001

### 重要提醒
- [ ] **不要启动 file-server**（音乐服务不需要）
- [ ] **只部署主服务**（ai-music-service）
- [ ] **使用 temp_audio 目录**（不是 temp_frames）
- [ ] **端口是 3001**（不是 5000 或 8081）

---

## 🎯 部署成功的标志

部署成功后，你应该看到：

### PM2 状态
```bash
$ pm2 status
┌─────┬──────────────────┬─────────┬─────────┬──────────┐
│ id  │ name             │ status  │ restart │ uptime   │
├─────┼──────────────────┼─────────┼─────────┼──────────┤
│ 0   │ ai-music-service │ online  │ 0       │ 10s      │
└─────┴──────────────────┴─────────┴─────────┴──────────┘
```

**注意**: 只有 1 个进程，没有 file-server！

### 健康检查
```bash
$ curl http://localhost:3001/health
{"status":"ok","timestamp":"...","service":"ai-music-service"}
```

### 服务信息
```bash
$ curl http://localhost:3001/
{
  "service": "AI 音乐服务",
  "version": "v2.0",
  "port": 3001,
  "taskManager": {
    "maxConcurrency": 10,
    "maxQueueSize": 2500
  },
  ...
}
```

---

## 📁 部署包内容

打包后的文件包含：

```
ai-music-service/
├── index.js                          # 主入口
├── package.json                      # 依赖配置
├── ecosystem.config.js               # PM2 配置（只有 1 个进程）
├── .env                              # 环境变量
├── .env.example                      # 环境变量示例
├── services/                         # 服务层
├── routes/                           # 路由层
├── types/                            # 类型定义
├── utils/                            # 工具函数
├── logs/                             # 日志目录（空）
├── temp_audio/                       # 临时文件（空）
├── data/                             # 数据存储（空）
├── 一键部署.sh                       # 部署脚本
├── 部署前检查.sh                     # 检查脚本
├── 部署到服务器指南.md               # 详细文档
├── 服务配置对比说明.md               # 配置对比
└── 部署配置总结.md                   # 配置汇总
```

**不包含**:
- ❌ node_modules（需要在服务器上安装）
- ❌ file-server.js（音乐服务不需要）
- ❌ 测试文件（test-*.js）
- ❌ 临时文件和日志

---

## ⚠️ 常见问题

### Q1: 为什么没有 file-server？
**A**: 音乐服务不需要文件服务器。Suno API 生成的音频直接从 Suno 下载，然后上传到 OSS，不需要提供临时访问 URL。

### Q2: 端口 8081 需要开放吗？
**A**: 不需要。8081 是视频服务的文件服务器端口，音乐服务只需要开放 3001 端口。

### Q3: 可以和视频服务共享文件服务器吗？
**A**: 不建议。两个服务完全独立，各自使用不同的临时目录和工作流程。

### Q4: OSS 接口是同一个吗？
**A**: 是的，两个服务使用同一个 OSS 签名 URL 接口。

---

## 📞 需要帮助？

如果部署过程中遇到问题，请查看：

1. **部署到服务器指南.md** - 详细的部署步骤和问题排查
2. **服务配置对比说明.md** - 了解与视频服务的区别
3. **部署配置总结.md** - 配置参数汇总

---

## 🎉 准备好了吗？

如果你已经确认了上述所有检查项，现在可以开始部署了！

**推荐步骤**:
1. 运行 `打包部署.bat` 打包项目
2. 上传到服务器
3. 运行 `./部署前检查.sh` 检查环境
4. 运行 `./一键部署.sh` 一键部署
5. 验证部署结果

祝部署顺利！🚀

