# AI éŸ³ä¹æœåŠ¡ v2.0 å‡çº§è¯´æ˜

## ğŸ“‹ å‡çº§æ¦‚è¿°

æœ¬æ¬¡å‡çº§å‚è€ƒ `zhu-zongyin-video` é¡¹ç›®ï¼Œå¯¹ AI éŸ³ä¹æœåŠ¡è¿›è¡Œäº†å…¨é¢æ”¹é€ ï¼Œä¸»è¦å¢åŠ äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

### âœ… æ ¸å¿ƒæ”¹è¿›

1. **ä»»åŠ¡ç®¡ç†å™¨** - å®Œæ•´çš„ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ç³»ç»Ÿ
   - å†…å­˜ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMap å­˜å‚¨ï¼‰
   - å¹¶å‘æ§åˆ¶ï¼ˆp-queueï¼Œé»˜è®¤10ä¸ªå¹¶å‘ï¼‰
   - çŠ¶æ€ç®¡ç†ï¼ˆpending/processing/completed/failedï¼‰
   - è‡ªåŠ¨æ¸…ç†ï¼ˆ5åˆ†é’Ÿååˆ é™¤å·²å®Œæˆä»»åŠ¡ï¼‰

2. **OSS ä¸Šä¼ æœåŠ¡** - è‡ªåŠ¨ä¸Šä¼ éŸ³é¢‘åˆ° OSS
   - è·å–é¢„ç­¾å URL
   - ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
   - è¿”å›æ–‡ä»¶åï¼ˆUUIDæ ¼å¼ï¼‰
   - è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶

3. **å›è°ƒæœåŠ¡** - ä»»åŠ¡å®Œæˆåä¸»åŠ¨é€šçŸ¥åç«¯
   - æ”¯æŒè‡ªå®šä¹‰å›è°ƒ URL
   - åªå‘é€æ–‡ä»¶åï¼Œä¸å‘é€å®Œæ•´éŸ³é¢‘æ•°æ®
   - å¤±è´¥é‡è¯•æœºåˆ¶

4. **å¼‚æ­¥å¤„ç†æ¨¡å¼** - æ‰€æœ‰ä»»åŠ¡å¼‚æ­¥å¤„ç†
   - ç«‹å³è¿”å›ä»»åŠ¡ IDï¼ˆ202 çŠ¶æ€ç ï¼‰
   - åå°å¼‚æ­¥å¤„ç†
   - è½®è¯¢ Suno API çŠ¶æ€
   - å®Œæˆåå›è°ƒé€šçŸ¥

---

## ğŸ“ æ–°å¢æ–‡ä»¶

```
ai_music_service_deploy/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ task.js                    # ä»»åŠ¡ç±»å‹å®šä¹‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ taskManager.js             # ä»»åŠ¡ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”œâ”€â”€ ossService.js              # OSSä¸Šä¼ æœåŠ¡
â”‚   â””â”€â”€ callbackService.js         # å›è°ƒæœåŠ¡
â””â”€â”€ temp_audio/                    # ä¸´æ—¶éŸ³é¢‘æ–‡ä»¶ç›®å½•
```

---

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `package.json`
æ–°å¢ä¾èµ–ï¼š
- `p-queue` - å¹¶å‘é˜Ÿåˆ—ç®¡ç†
- `uuid` - ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å

### 2. `.env`
æ–°å¢é…ç½®ï¼š
```bash
# ä»»åŠ¡ç®¡ç†å™¨é…ç½®
MAX_CONCURRENCY=10
MAX_QUEUE_SIZE=2500

# OSS é…ç½®
OSS_SIGNED_URL_API=https://ai.mediaio.net/api/v1/ai/signed-upload-url
OSS_UPLOAD_TIMEOUT=60000

# å›è°ƒé…ç½®
CALLBACK_TIMEOUT=10000

# ä¸´æ—¶æ–‡ä»¶ç›®å½•
TEMP_DIR=./temp_audio
```

### 3. `index.js`
- å¼•å…¥ä»»åŠ¡ç®¡ç†å™¨
- åˆ›å»º `temp_audio` ç›®å½•
- æ›´æ–°æœåŠ¡ä¿¡æ¯å±•ç¤º

### 4. `routes/music.js`
æ”¹é€ ä¸ºå¼‚æ­¥ä»»åŠ¡æ¨¡å¼ï¼š
- `POST /api/music/generate-lyrics` - éœ€è¦ `callbackUrl` å‚æ•°
- `POST /api/music/generate` - éœ€è¦ `callbackUrl` å‚æ•°
- `POST /api/music/add-vocals` - éœ€è¦ `callbackUrl` å‚æ•°
- `GET /api/music/task/:taskId` - ä»ä»»åŠ¡ç®¡ç†å™¨æŸ¥è¯¢
- `GET /api/music/stats` - æ–°å¢ç»Ÿè®¡æ¥å£

---

## ğŸ”„ å·¥ä½œæµç¨‹å˜åŒ–

### æ—§ç‰ˆæµç¨‹ï¼ˆåŒæ­¥ï¼‰
```
1. å‰ç«¯è°ƒç”¨ API
2. ä¸­å°è°ƒç”¨ Suno API
3. ä¸­å°ç­‰å¾… Suno è¿”å›
4. ä¸­å°è¿”å›ç»“æœç»™å‰ç«¯
```

### æ–°ç‰ˆæµç¨‹ï¼ˆå¼‚æ­¥ + OSSï¼‰
```
1. åç«¯è°ƒç”¨ APIï¼ˆå¸¦ callbackUrlï¼‰
   POST /api/music/generate
   { prompt, model, callbackUrl, ... }

2. ä¸­å°ç«‹å³è¿”å›ä»»åŠ¡IDï¼ˆ202ï¼‰
   { taskId, status: "pending", progress: 0 }

3. ä¸­å°åå°å¤„ç†
   - è°ƒç”¨ Suno API
   - è½®è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆæ¯5ç§’ï¼‰
   - ä¸‹è½½éŸ³é¢‘æ–‡ä»¶
   - ä¸Šä¼ åˆ° OSS
   - è·å–æ–‡ä»¶å

4. ä¸­å°å›è°ƒåç«¯
   POST {callbackUrl}
   {
     taskId,
     taskType: "music_generation",
     status: "completed",
     result: {
       clips: [
         { fileName: "uuid.mp3", ... }
       ]
     }
   }

5. åç«¯å¯éšæ—¶æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
   GET /api/music/task/:taskId
```

---

## ğŸ“Š API å˜åŒ–

### æ–°å¢å¿…å¡«å‚æ•°

æ‰€æœ‰å¼‚æ­¥æ¥å£éƒ½éœ€è¦ `callbackUrl` å‚æ•°ï¼š

```javascript
// ç”Ÿæˆæ­Œè¯
POST /api/music/generate-lyrics
{
  "prompt": "å†™ä¸€é¦–å…³äºçˆ±æƒ…çš„æ­Œ",
  "callbackUrl": "https://your-backend.com/api/callback/lyrics"  // æ–°å¢
}

// ç”ŸæˆéŸ³ä¹
POST /api/music/generate
{
  "model": "chirp-v3-5",
  "prompt": "æµè¡ŒéŸ³ä¹",
  "callbackUrl": "https://your-backend.com/api/callback/music"  // æ–°å¢
}

// æ·»åŠ äººå£°
POST /api/music/add-vocals
{
  "uploadUrl": "https://...",
  "prompt": "...",
  "style": "...",
  "callbackUrl": "https://your-backend.com/api/callback/vocals"  // æ–°å¢
}
```

### å“åº”æ ¼å¼å˜åŒ–

**æ—§ç‰ˆï¼ˆåŒæ­¥ï¼‰ï¼š**
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "taskId": "suno-task-id",
    "clips": [...]
  }
}
```

**æ–°ç‰ˆï¼ˆå¼‚æ­¥ï¼‰ï¼š**
```json
{
  "code": 202,
  "msg": "Task created successfully",
  "data": {
    "taskId": "local-task-id",
    "status": "pending",
    "progress": 0
  }
}
```

### å›è°ƒæ•°æ®æ ¼å¼

```json
{
  "taskId": "local-task-id",
  "taskType": "music_generation",
  "status": "completed",
  "result": {
    "clips": [
      {
        "fileName": "f9e8d7c6-b5a4-3210-9876-543210fedcba.mp3",
        "id": "...",
        "title": "...",
        "tags": "..."
      }
    ],
    "sunoTaskId": "suno-task-id"
  },
  "completedAt": "2024-01-01T00:00:00.000Z"
}
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **å®‰è£…æ–°ä¾èµ–**
   ```bash
   npm install
   ```

2. **æ›´æ–°ç¯å¢ƒå˜é‡**
   ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œæ·»åŠ æ–°çš„é…ç½®é¡¹

3. **åˆ›å»ºä¸´æ—¶ç›®å½•**
   ```bash
   mkdir temp_audio
   ```

4. **é‡å¯æœåŠ¡**
   ```bash
   pm2 restart ecosystem.config.js
   ```

5. **éªŒè¯æœåŠ¡**
   ```bash
   curl http://localhost:3001/
   curl http://localhost:3001/health
   curl http://localhost:3001/api/music/stats
   ```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å›è°ƒ URL å¿…é¡»å¯è®¿é—®**
   - ç¡®ä¿åç«¯çš„å›è°ƒ URL å¯ä»¥è¢«ä¸­å°è®¿é—®
   - å»ºè®®ä½¿ç”¨ HTTPS

2. **OSS é…ç½®**
   - ç¡®ä¿ `OSS_SIGNED_URL_API` é…ç½®æ­£ç¡®
   - æµ‹è¯•ç­¾å URL æ˜¯å¦å¯ç”¨

3. **ä»»åŠ¡æ¸…ç†**
   - å·²å®Œæˆçš„ä»»åŠ¡ä¼šåœ¨ 5 åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†
   - å¦‚éœ€é•¿æœŸä¿å­˜ï¼Œè¯·åœ¨å›è°ƒåç«‹å³ä¿å­˜åˆ°æ•°æ®åº“

4. **å¹¶å‘æ§åˆ¶**
   - é»˜è®¤æœ€å¤š 10 ä¸ªå¹¶å‘ä»»åŠ¡
   - å¯é€šè¿‡ `MAX_CONCURRENCY` è°ƒæ•´

5. **é˜Ÿåˆ—å®¹é‡**
   - é»˜è®¤æœ€å¤š 2500 ä¸ªä»»åŠ¡
   - è¶…è¿‡ä¼šè¿”å› 500 é”™è¯¯

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **å¹¶å‘å¤„ç†** - å¤šä¸ªä»»åŠ¡åŒæ—¶å¤„ç†
2. **å¼‚æ­¥æ¨¡å¼** - ä¸é˜»å¡ä¸»çº¿ç¨‹
3. **è‡ªåŠ¨æ¸…ç†** - é˜²æ­¢å†…å­˜æ³„æ¼
4. **OSS ä¸Šä¼ ** - å‡å°‘å¸¦å®½æ¶ˆè€—

---

## ğŸ› æ•…éšœæ’æŸ¥

### ä»»åŠ¡ä¸€ç›´å¤„äº pending çŠ¶æ€
- æ£€æŸ¥ Suno API æ˜¯å¦æ­£å¸¸
- æŸ¥çœ‹æ—¥å¿—ï¼š`pm2 logs`

### å›è°ƒå¤±è´¥
- æ£€æŸ¥ `callbackUrl` æ˜¯å¦å¯è®¿é—®
- æŸ¥çœ‹å›è°ƒæ—¥å¿—

### OSS ä¸Šä¼ å¤±è´¥
- æ£€æŸ¥ `OSS_SIGNED_URL_API` é…ç½®
- æ£€æŸ¥ç½‘ç»œè¿æ¥

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
pm2 logs ai-music-service
```

æˆ–è®¿é—®ï¼š
```
http://localhost:3001/api/music/stats
```

