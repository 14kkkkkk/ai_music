# å›è°ƒæ¥å£ä¿®å¤æ€»ç»“

## ğŸ¯ ä¿®å¤ç›®æ ‡

1. âœ… æ·»åŠ  `metadata` å­—æ®µåˆ°æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡çš„å›è°ƒä¸­
2. âœ… ç¡®ä¿å›è°ƒæ•°æ®ä¸­ä¸åŒ…å« `undefined` å€¼
3. âœ… ç»Ÿä¸€å›è°ƒæ•°æ®æ ¼å¼

## ğŸ“‹ ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ 1: metadata å­—æ®µç¼ºå¤±

**ç°è±¡**ï¼šä¸­å°è°ƒç”¨ç”Ÿæˆæ­Œè¯æ¥å£åï¼Œå›è°ƒä¸­çš„ `metadata` å­—æ®µä¸º `undefined`

**åŸå› **ï¼šå›è°ƒ payload ä¸­æ²¡æœ‰åŒ…å« `metadata` å­—æ®µ

**è§£å†³**ï¼šåœ¨ `notifyBackend` æ–¹æ³•ä¸­æ·»åŠ  `metadata` å­—æ®µçš„æ„å»ºé€»è¾‘

### é—®é¢˜ 2: å­—æ®µå€¼ä¸º undefined

**ç°è±¡**ï¼šæŸäº›å­—æ®µå¯èƒ½è¿”å› `undefined`ï¼Œå¯¼è‡´ JSON åºåˆ—åŒ–æ—¶å­—æ®µä¸¢å¤±

**åŸå› **ï¼š
- ä»»åŠ¡åˆ›å»ºæ—¶æ²¡æœ‰ä¸ºå¯é€‰å­—æ®µè®¾ç½®é»˜è®¤å€¼
- å›è°ƒ payload æ„å»ºæ—¶æ²¡æœ‰å¤„ç†ç©ºå€¼

**è§£å†³**ï¼š
- åœ¨ä»»åŠ¡åˆ›å»ºæ—¶ä¸ºæ‰€æœ‰å­—æ®µæ·»åŠ é»˜è®¤å€¼
- åœ¨å›è°ƒ payload æ„å»ºæ—¶ä½¿ç”¨ `||` è¿ç®—ç¬¦æä¾›é»˜è®¤å€¼
- ä½¿ç”¨ `null` è€Œä¸æ˜¯ `undefined` è¡¨ç¤ºç©ºå¯¹è±¡

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

### 1. services/taskManager.js

#### ä¿®æ”¹ä½ç½® 1: createMusicGenerationTask (ç¬¬ 46-63 è¡Œ)
```javascript
input: {
  customMode: request.customMode !== undefined ? request.customMode : false,
  instrumental: request.instrumental || false,
  model: request.model || '',
  prompt: request.prompt || '',
  title: request.title || '',
  tags: request.tags || '',
  negativeTags: request.negativeTags || 'æ— '
}
```

#### ä¿®æ”¹ä½ç½® 2: createLyricsGenerationTask (ç¬¬ 91-102 è¡Œ)
```javascript
input: {
  prompt: request.prompt || ''
}
```

#### ä¿®æ”¹ä½ç½® 3: createAddVocalsTask (ç¬¬ 127-143 è¡Œ)
```javascript
input: {
  uploadUrl: request.uploadUrl || '',
  prompt: request.prompt || '',
  title: request.title || '',
  style: request.style || '',
  negativeTags: request.negativeTags || 'æ— ',
  vocalGender: request.vocalGender || 'f'
}
```

#### ä¿®æ”¹ä½ç½® 4: notifyBackend (ç¬¬ 600-644 è¡Œ)
```javascript
// æ„å»º metadata å­—æ®µ
let metadata = {};

if (task.type === TaskType.LYRICS_GENERATION) {
  metadata = {
    type: 'lyrics',
    prompt: task.input.prompt || ''
  };
} else if (task.type === TaskType.MUSIC_GENERATION) {
  metadata = {
    type: 'music',
    prompt: task.input.prompt || '',
    model: task.input.model || '',
    title: task.input.title || '',
    tags: task.input.tags || ''
  };
} else if (task.type === TaskType.ADD_VOCALS) {
  metadata = {
    type: 'vocals',
    prompt: task.input.prompt || '',
    style: task.input.style || ''
  };
}

const payload = {
  taskId: task.id || '',
  status: task.status || '',
  result: result || null,
  metadata,
  error: error || null,
  completedAt: new Date().toISOString()
};
```

### 2. services/callbackService.js

#### ä¿®æ”¹ä½ç½®: æ—¥å¿—è¾“å‡º (ç¬¬ 27-33ã€53-60ã€67-76 è¡Œ)
```javascript
// å°† taskType æ”¹ä¸º metadata.type
logger.info(`ğŸ“¤ å¼€å§‹å›è°ƒåç«¯: ${callbackUrl}`, {
  taskId: payload.taskId,
  status: payload.status,
  metadataType: payload.metadata?.type,  // âœ… ä½¿ç”¨ metadata.type
  payloadSize: JSON.stringify(payload).length
});
```

## ğŸ“Š ä¿®å¤åçš„å›è°ƒæ ¼å¼

### æ­Œè¯ç”Ÿæˆä»»åŠ¡
```json
{
  "taskId": "abc123...",
  "status": "completed",
  "result": {
    "lyrics": "...",
    "title": "...",
    "sunoTaskId": "..."
  },
  "metadata": {
    "type": "lyrics",
    "prompt": "ä¸€é¦–å…³äºå¤å¤©æµ·è¾¹çš„æ­Œ"
  },
  "error": null,
  "completedAt": "2025-11-24T10:30:00.000Z"
}
```

### éŸ³ä¹ç”Ÿæˆä»»åŠ¡
```json
{
  "taskId": "abc123...",
  "status": "completed",
  "result": {
    "clips": [...],
    "sunoTaskId": "..."
  },
  "metadata": {
    "type": "music",
    "prompt": "æµè¡ŒéŸ³ä¹",
    "model": "chirp-v3-5",
    "title": "å¤æ—¥æµ·è¾¹",
    "tags": "æµè¡Œ, è½»å¿«"
  },
  "error": null,
  "completedAt": "2025-11-24T10:35:00.000Z"
}
```

### æ·»åŠ äººå£°ä»»åŠ¡
```json
{
  "taskId": "abc123...",
  "status": "completed",
  "result": {
    "clips": [...],
    "sunoTaskId": "..."
  },
  "metadata": {
    "type": "vocals",
    "prompt": "[Verse 1]\\n...",
    "style": "æµè¡Œ"
  },
  "error": null,
  "completedAt": "2025-11-24T10:40:00.000Z"
}
```

## âœ… éªŒè¯æ¸…å•

- [x] æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡å›è°ƒåŒ…å« `metadata` å­—æ®µ
- [x] `metadata.type` æ­£ç¡®æ ‡è¯†ä»»åŠ¡ç±»å‹
- [x] `metadata.prompt` åŒ…å«ç”¨æˆ·è¾“å…¥
- [x] å›è°ƒæ•°æ®ä¸­æ²¡æœ‰ `undefined` å€¼
- [x] ç©ºå€¼ä½¿ç”¨ `null` æˆ–ç©ºå­—ç¬¦ä¸² `''` è¡¨ç¤º
- [x] å¤±è´¥å›è°ƒä¹ŸåŒ…å« `metadata` å­—æ®µ
- [x] æ—¥å¿—è¾“å‡ºä½¿ç”¨ `metadata.type` æ›¿ä»£ `taskType`

## ğŸ§ª æµ‹è¯•è„šæœ¬

1. **test-lyrics-callback.js** - æµ‹è¯•æ­Œè¯ç”Ÿæˆå›è°ƒçš„ metadata å­—æ®µ
2. **test-no-undefined.js** - æµ‹è¯•å›è°ƒæ•°æ®ä¸­æ²¡æœ‰ undefined å€¼
3. **test-all-callbacks.js** - æµ‹è¯•æ‰€æœ‰æ¥å£çš„å›è°ƒæ ¼å¼

è¿è¡Œæµ‹è¯•ï¼š
```bash
node test-no-undefined.js
```

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **ç§»é™¤äº† taskType å­—æ®µ**ï¼šä¸­å°éœ€è¦æ”¹ç”¨ `metadata.type`
2. **ä¸è¦ä½¿ç”¨ undefined**ï¼šæ‰€æœ‰å­—æ®µéƒ½å¿…é¡»æœ‰æ˜ç¡®çš„å€¼
3. **ç©ºå€¼è§„èŒƒ**ï¼š
   - å­—ç¬¦ä¸²ï¼šä½¿ç”¨ `''` (ç©ºå­—ç¬¦ä¸²)
   - å¸ƒå°”å€¼ï¼šä½¿ç”¨ `false`
   - å¯¹è±¡ï¼šä½¿ç”¨ `null`
   - æ•°ç»„ï¼šä½¿ç”¨ `[]` (ç©ºæ•°ç»„)

