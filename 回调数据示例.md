# 回调数据示例

## 歌词生成任务回调

### 成功回调

```json
{
  "taskId": "d1bce47c-95ba-4726-88a6-861a2270cafc",
  "status": "completed",
  "result": {
    "lyrics": "[Verse 1]\n海风轻轻吹过...\n\n[Chorus]\n夏天的海边...",
    "title": "夏日海边",
    "sunoTaskId": "abc123-suno-task-id"
  },
  "metadata": {
    "type": "lyrics",
    "prompt": "一首关于夏天海边的歌"
  },
  "error": null,
  "completedAt": "2025-11-24T10:30:00.000Z"
}
```

### 失败回调

```json
{
  "taskId": "d1bce47c-95ba-4726-88a6-861a2270cafc",
  "status": "failed",
  "result": null,
  "metadata": {
    "type": "lyrics",
    "prompt": "一首关于夏天海边的歌"
  },
  "error": "Suno API 调用失败: 超时",
  "completedAt": "2025-11-24T10:30:00.000Z"
}
```

## 音乐生成任务回调

### 成功回调

```json
{
  "taskId": "e2cdf58d-a6cb-5837-99b7-972b3381dbgd",
  "status": "completed",
  "result": {
    "clips": [
      {
        "id": "clip-id-1",
        "title": "夏日海边",
        "tags": "流行, 轻快",
        "duration": 180,
        "fileName": "music_1732445400000_abc123.mp3"
      }
    ],
    "sunoTaskId": "abc123-suno-task-id"
  },
  "metadata": {
    "type": "music",
    "prompt": "流行音乐，轻快的节奏",
    "model": "chirp-v3-5",
    "title": "夏日海边",
    "tags": "流行, 轻快"
  },
  "error": null,
  "completedAt": "2025-11-24T10:35:00.000Z"
}
```

## 添加人声任务回调

### 成功回调

```json
{
  "taskId": "f3def69e-b7dc-6948-aac8-a83c4492ecif",
  "status": "completed",
  "result": {
    "clips": [
      {
        "id": "clip-id-1",
        "title": "夏日海边（人声版）",
        "duration": 180,
        "fileName": "vocals_1732445500000_def456.mp3"
      }
    ],
    "sunoTaskId": "def456-suno-task-id"
  },
  "metadata": {
    "type": "vocals",
    "prompt": "[Verse 1]\n海风轻轻吹过...",
    "style": "流行"
  },
  "error": null,
  "completedAt": "2025-11-24T10:40:00.000Z"
}
```

## 中台处理示例

### Node.js / Express

```javascript
// 回调接收端点
app.post('/api/callback/lyrics', async (req, res) => {
  const { taskId, status, result, metadata, error } = req.body;
  
  try {
    // 1. 验证必填字段
    if (!taskId || !status) {
      return res.status(400).json({
        code: 400,
        msg: 'taskId and status are required'
      });
    }
    
    // 2. 根据任务类型处理
    if (metadata.type === 'lyrics') {
      if (status === 'completed' && result) {
        // 保存歌词到数据库
        await saveLyricsToDatabase({
          taskId,
          lyrics: result.lyrics,
          title: result.title,
          prompt: metadata.prompt,
          sunoTaskId: result.sunoTaskId
        });
        
        console.log('✅ 歌词生成成功:', {
          taskId,
          title: result.title,
          prompt: metadata.prompt
        });
      } else if (status === 'failed') {
        // 记录失败
        console.error('❌ 歌词生成失败:', {
          taskId,
          error,
          prompt: metadata.prompt
        });
      }
    }
    
    // 3. 返回成功响应
    res.json({ code: 200, msg: 'success' });
    
  } catch (err) {
    console.error('处理回调失败:', err);
    res.status(500).json({
      code: 500,
      msg: err.message
    });
  }
});
```

### Python / Flask

```python
from flask import Flask, request, jsonify

app = Flask(__name__)

@app.route('/api/callback/lyrics', methods=['POST'])
def handle_lyrics_callback():
    data = request.json
    
    task_id = data.get('taskId')
    status = data.get('status')
    result = data.get('result')
    metadata = data.get('metadata', {})
    error = data.get('error')
    
    # 验证必填字段
    if not task_id or not status:
        return jsonify({
            'code': 400,
            'msg': 'taskId and status are required'
        }), 400
    
    # 根据任务类型处理
    if metadata.get('type') == 'lyrics':
        if status == 'completed' and result:
            # 保存歌词到数据库
            save_lyrics_to_database({
                'task_id': task_id,
                'lyrics': result.get('lyrics'),
                'title': result.get('title'),
                'prompt': metadata.get('prompt'),
                'suno_task_id': result.get('sunoTaskId')
            })
            
            print(f"✅ 歌词生成成功: {task_id}")
        elif status == 'failed':
            print(f"❌ 歌词生成失败: {task_id}, 错误: {error}")
    
    return jsonify({'code': 200, 'msg': 'success'})
```

## 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `taskId` | string | 任务ID（中台创建任务时返回的ID） |
| `status` | string | 任务状态：`completed`（成功）、`failed`（失败） |
| `result` | object/null | 任务结果，成功时包含具体数据，失败时为 null |
| `metadata` | object | 任务元数据，包含任务类型和输入参数 |
| `metadata.type` | string | 任务类型：`lyrics`（歌词）、`music`（音乐）、`vocals`（人声） |
| `metadata.prompt` | string | 用户输入的提示词 |
| `error` | string/null | 错误信息，成功时为 null |
| `completedAt` | string | 任务完成时间（ISO 8601 格式） |

