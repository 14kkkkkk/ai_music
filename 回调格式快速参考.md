# å›è°ƒæ ¼å¼å¿«é€Ÿå‚è€ƒ

## ğŸ“¦ ç»Ÿä¸€å›è°ƒæ ¼å¼

æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡çš„å›è°ƒéƒ½éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š

```json
{
  "taskId": "ä»»åŠ¡ID",
  "status": "completed | failed",
  "result": { /* ä»»åŠ¡ç»“æœ */ } | null,
  "metadata": {
    "type": "ä»»åŠ¡ç±»å‹",
    /* å…¶ä»–å…ƒæ•°æ® */
  },
  "error": "é”™è¯¯ä¿¡æ¯" | null,
  "completedAt": "ISO 8601 æ—¶é—´æˆ³"
}
```

## ğŸµ æ­Œè¯ç”Ÿæˆ `/api/music/generate-lyrics`

### æˆåŠŸå›è°ƒ
```json
{
  "taskId": "abc123...",
  "status": "completed",
  "result": {
    "lyrics": "[Verse 1]\næµ·é£è½»è½»å¹è¿‡...",
    "title": "å¤æ—¥æµ·è¾¹",
    "sunoTaskId": "suno-task-id"
  },
  "metadata": {
    "type": "lyrics",
    "prompt": "ä¸€é¦–å…³äºå¤å¤©æµ·è¾¹çš„æ­Œ"
  },
  "error": null,
  "completedAt": "2025-11-24T10:30:00.000Z"
}
```

### å¤±è´¥å›è°ƒ
```json
{
  "taskId": "abc123...",
  "status": "failed",
  "result": null,
  "metadata": {
    "type": "lyrics",
    "prompt": "ä¸€é¦–å…³äºå¤å¤©æµ·è¾¹çš„æ­Œ"
  },
  "error": "Suno API è°ƒç”¨å¤±è´¥",
  "completedAt": "2025-11-24T10:30:00.000Z"
}
```

## ğŸ¼ éŸ³ä¹ç”Ÿæˆ `/api/music/generate`

### æˆåŠŸå›è°ƒ
```json
{
  "taskId": "def456...",
  "status": "completed",
  "result": {
    "clips": [
      {
        "id": "clip-id",
        "title": "å¤æ—¥æµ·è¾¹",
        "tags": "æµè¡Œ, è½»å¿«",
        "duration": 180,
        "fileName": "music_1732445400000_abc123.mp3"
      }
    ],
    "sunoTaskId": "suno-task-id"
  },
  "metadata": {
    "type": "music",
    "prompt": "æµè¡ŒéŸ³ä¹ï¼Œè½»å¿«çš„èŠ‚å¥",
    "model": "chirp-v3-5",
    "title": "å¤æ—¥æµ·è¾¹",
    "tags": "æµè¡Œ, è½»å¿«"
  },
  "error": null,
  "completedAt": "2025-11-24T10:35:00.000Z"
}
```

## ğŸ¤ æ·»åŠ äººå£° `/api/music/add-vocals`

### æˆåŠŸå›è°ƒ
```json
{
  "taskId": "ghi789...",
  "status": "completed",
  "result": {
    "clips": [
      {
        "id": "clip-id",
        "title": "å¤æ—¥æµ·è¾¹ï¼ˆäººå£°ç‰ˆï¼‰",
        "duration": 180,
        "fileName": "vocals_1732445500000_def456.mp3"
      }
    ],
    "sunoTaskId": "suno-task-id"
  },
  "metadata": {
    "type": "vocals",
    "prompt": "[Verse 1]\næµ·é£è½»è½»å¹è¿‡...",
    "style": "æµè¡Œ"
  },
  "error": null,
  "completedAt": "2025-11-24T10:40:00.000Z"
}
```

## ğŸ“‹ å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `taskId` | string | âœ… | ä»»åŠ¡ID |
| `status` | string | âœ… | ä»»åŠ¡çŠ¶æ€ï¼š`completed`ï¼ˆæˆåŠŸï¼‰ã€`failed`ï¼ˆå¤±è´¥ï¼‰ |
| `result` | object/null | âœ… | ä»»åŠ¡ç»“æœï¼ŒæˆåŠŸæ—¶åŒ…å«æ•°æ®ï¼Œå¤±è´¥æ—¶ä¸º `null` |
| `metadata` | object | âœ… | ä»»åŠ¡å…ƒæ•°æ® |
| `metadata.type` | string | âœ… | ä»»åŠ¡ç±»å‹ï¼š`lyrics`ã€`music`ã€`vocals` |
| `metadata.prompt` | string | âœ… | ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯ |
| `error` | string/null | âœ… | é”™è¯¯ä¿¡æ¯ï¼ŒæˆåŠŸæ—¶ä¸º `null` |
| `completedAt` | string | âœ… | ä»»åŠ¡å®Œæˆæ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰ |

## âš ï¸ é‡è¦æç¤º

### 1. ä¸ä¼šè¿”å› undefined

æ‰€æœ‰å­—æ®µéƒ½æœ‰æ˜ç¡®çš„å€¼ï¼š
- âœ… å­—ç¬¦ä¸²å­—æ®µï¼šç©ºå€¼ä¸º `""`ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰
- âœ… å¯¹è±¡å­—æ®µï¼šç©ºå€¼ä¸º `null`
- âœ… å¸ƒå°”å­—æ®µï¼šé»˜è®¤ä¸º `false`
- âŒ æ°¸è¿œä¸ä¼šå‡ºç° `undefined`

### 2. metadata å­—æ®µå§‹ç»ˆå­˜åœ¨

å³ä½¿ä»»åŠ¡å¤±è´¥ï¼Œ`metadata` å­—æ®µä¹Ÿä¼šå­˜åœ¨ï¼ŒåŒ…å«ä»»åŠ¡çš„åŸºæœ¬ä¿¡æ¯ã€‚

### 3. å‘åå…¼å®¹æ€§

- âŒ ç§»é™¤äº† `taskType` å­—æ®µ
- âœ… ä½¿ç”¨ `metadata.type` æ›¿ä»£

### 4. ä¸­å°å¤„ç†ç¤ºä¾‹

```javascript
// âŒ æ—§ä»£ç ï¼ˆä¸å†æœ‰æ•ˆï¼‰
if (data.taskType === 'lyrics_generation') {
  // ...
}

// âœ… æ–°ä»£ç 
if (data.metadata.type === 'lyrics') {
  // ...
}
```

## ğŸ§ª æµ‹è¯•

```bash
# æµ‹è¯• metadata å­—æ®µ
node test-lyrics-callback.js

# æµ‹è¯•æ²¡æœ‰ undefined å€¼
node test-no-undefined.js

# æµ‹è¯•æ‰€æœ‰æ¥å£
node test-all-callbacks.js
```

## ğŸ“ è”ç³»

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š
- `ä¿®å¤metadataå­—æ®µè¯´æ˜.md` - è¯¦ç»†ä¿®å¤è¯´æ˜
- `å›è°ƒæ¥å£ä¿®å¤æ€»ç»“.md` - ä¿®å¤æ€»ç»“
- `å›è°ƒæ•°æ®ç¤ºä¾‹.md` - æ›´å¤šç¤ºä¾‹å’Œä¸­å°å¤„ç†ä»£ç 

