# ğŸ”§ å¸¸è§é—®é¢˜ä¿®å¤æŒ‡å—

## âŒ é—®é¢˜ 1: Cannot find module 'uuid'

### é”™è¯¯ä¿¡æ¯
```
Error: Cannot find module 'uuid'
Require stack:
- /root/ai_music/ai_music/services/taskManager.js
```

### åŸå› 
ä¾èµ–åŒ…æœªæ­£ç¡®å®‰è£…ï¼Œé€šå¸¸æ˜¯å› ä¸ºï¼š
1. `npm install` æ‰§è¡Œå¤±è´¥
2. `node_modules` ç›®å½•ä¸å®Œæ•´
3. ç½‘ç»œé—®é¢˜å¯¼è‡´éƒ¨åˆ†åŒ…æœªä¸‹è½½

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ä¿®å¤è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
cd /root/ai_music/ai_music
chmod +x ä¿®å¤ä¾èµ–.sh
./ä¿®å¤ä¾èµ–.sh
```

#### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨ä¿®å¤
```bash
cd /root/ai_music/ai_music

# 1. åœæ­¢æœåŠ¡
pm2 stop ai-music-service

# 2. æ¸…ç†æ—§ä¾èµ–
rm -rf node_modules
rm -f package-lock.json

# 3. é‡æ–°å®‰è£…
npm install

# 4. æ£€æŸ¥å…³é”®ä¾èµ–
ls node_modules/ | grep -E "uuid|p-queue|express|axios|winston"

# 5. é‡å¯æœåŠ¡
pm2 restart ai-music-service

# 6. æŸ¥çœ‹æ—¥å¿—
pm2 logs ai-music-service
```

#### æ–¹æ³•ä¸‰ï¼šå•ç‹¬å®‰è£…ç¼ºå¤±çš„åŒ…
```bash
cd /root/ai_music/ai_music

# å®‰è£…ç¼ºå¤±çš„åŒ…
npm install uuid@13.0.0
npm install p-queue@9.0.0
npm install express@4.18.2
npm install axios@1.6.0
npm install winston@3.11.0

# é‡å¯æœåŠ¡
pm2 restart ai-music-service
```

---

## âŒ é—®é¢˜ 2: æœåŠ¡å¯åŠ¨åç«‹å³é€€å‡º

### é”™è¯¯ä¿¡æ¯
```
pm2 status æ˜¾ç¤ºæœåŠ¡çŠ¶æ€ä¸º errored æˆ– stopped
```

### è§£å†³æ–¹æ¡ˆ

#### 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```bash
pm2 logs ai-music-service --err
```

#### 2. æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
```bash
cd /root/ai_music/ai_music
node index.js
```

è¿™æ ·å¯ä»¥çœ‹åˆ°å®Œæ•´çš„é”™è¯¯ä¿¡æ¯ã€‚

#### 3. æ£€æŸ¥é…ç½®æ–‡ä»¶
```bash
# æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨
cat .env

# æ£€æŸ¥å¿…è¦çš„é…ç½®é¡¹
grep -E "PORT|SUNO_API_KEY|OSS_SIGNED_URL_API" .env
```

---

## âŒ é—®é¢˜ 3: ç«¯å£è¢«å ç”¨

### é”™è¯¯ä¿¡æ¯
```
Error: listen EADDRINUSE: address already in use :::3001
```

### è§£å†³æ–¹æ¡ˆ

#### 1. æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
```bash
netstat -tuln | grep 3001
lsof -i :3001
```

#### 2. æ€æ­»å ç”¨ç«¯å£çš„è¿›ç¨‹
```bash
# æŸ¥æ‰¾è¿›ç¨‹ PID
lsof -i :3001

# æ€æ­»è¿›ç¨‹
kill -9 <PID>
```

#### 3. æˆ–è€…ä¿®æ”¹ç«¯å£
```bash
# ç¼–è¾‘ .env æ–‡ä»¶
vim .env

# ä¿®æ”¹ PORT ä¸ºå…¶ä»–ç«¯å£ï¼Œä¾‹å¦‚ 3002
PORT=3002

# é‡å¯æœåŠ¡
pm2 restart ai-music-service
```

---

## âŒ é—®é¢˜ 4: npm install å¤±è´¥

### é”™è¯¯ä¿¡æ¯
```
npm ERR! network timeout
npm ERR! network This is a problem related to network connectivity
```

### è§£å†³æ–¹æ¡ˆ

#### 1. ä½¿ç”¨å›½å†…é•œåƒ
```bash
# è®¾ç½®æ·˜å®é•œåƒ
npm config set registry https://registry.npmmirror.com

# é‡æ–°å®‰è£…
npm install

# æ¢å¤å®˜æ–¹é•œåƒï¼ˆå¯é€‰ï¼‰
npm config set registry https://registry.npmjs.org
```

#### 2. å¢åŠ è¶…æ—¶æ—¶é—´
```bash
npm install --timeout=60000
```

#### 3. ä½¿ç”¨ cnpm
```bash
# å®‰è£… cnpm
npm install -g cnpm --registry=https://registry.npmmirror.com

# ä½¿ç”¨ cnpm å®‰è£…ä¾èµ–
cnpm install
```

---

## âŒ é—®é¢˜ 5: PM2 è¿›ç¨‹æ˜¾ç¤º 2 ä¸ª

### é”™è¯¯ä¿¡æ¯
```
pm2 status æ˜¾ç¤º ai-music-service å’Œ ai-music-file-server ä¸¤ä¸ªè¿›ç¨‹
```

### åŸå› 
ä½¿ç”¨äº†é”™è¯¯çš„é…ç½®æ–‡ä»¶æˆ–æ—§çš„ PM2 é…ç½®

### è§£å†³æ–¹æ¡ˆ

#### 1. åˆ é™¤æ‰€æœ‰è¿›ç¨‹
```bash
pm2 delete all
```

#### 2. æ£€æŸ¥ ecosystem.config.js
```bash
cat ecosystem.config.js
```

ç¡®ä¿åªæœ‰ä¸€ä¸ª app é…ç½®ï¼ˆai-music-serviceï¼‰ï¼Œæ²¡æœ‰ file-serverã€‚

#### 3. é‡æ–°å¯åŠ¨
```bash
pm2 start ecosystem.config.js
pm2 save
```

---

## âŒ é—®é¢˜ 6: å¥åº·æ£€æŸ¥å¤±è´¥

### é”™è¯¯ä¿¡æ¯
```
curl http://localhost:3001/health
curl: (7) Failed to connect to localhost port 3001: Connection refused
```

### è§£å†³æ–¹æ¡ˆ

#### 1. æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
```bash
pm2 status
```

#### 2. æ£€æŸ¥æ—¥å¿—
```bash
pm2 logs ai-music-service
```

#### 3. æ£€æŸ¥ç«¯å£
```bash
netstat -tuln | grep 3001
```

#### 4. æ£€æŸ¥é˜²ç«å¢™
```bash
# CentOS/RHEL
firewall-cmd --list-ports

# Ubuntu
ufw status
```

---

## âŒ é—®é¢˜ 7: OSS ä¸Šä¼ å¤±è´¥

### é”™è¯¯ä¿¡æ¯
```
OSS ä¸Šä¼ å¤±è´¥: Request failed with status code 403
```

### è§£å†³æ–¹æ¡ˆ

#### 1. æ£€æŸ¥ OSS æ¥å£é…ç½®
```bash
grep OSS_SIGNED_URL_API .env
```

åº”è¯¥æ˜¯ï¼š`https://ai.mediaio.net/api/v1/ai/signed-upload-url`

#### 2. æµ‹è¯• OSS æ¥å£
```bash
curl "https://ai.mediaio.net/api/v1/ai/signed-upload-url?fileName=test.mp3"
```

#### 3. æ£€æŸ¥ç½‘ç»œè¿æ¥
```bash
ping ai.mediaio.net
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
pm2 logs ai-music-service --lines 100
```

### 2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
```bash
pm2 logs ai-music-service --err
```

### 3. æŸ¥çœ‹åº”ç”¨æ—¥å¿—
```bash
tail -f logs/combined.log
tail -f logs/error.log
```

### 4. é‡å¯æœåŠ¡å¹¶æŸ¥çœ‹æ—¥å¿—
```bash
pm2 restart ai-music-service && pm2 logs ai-music-service
```

### 5. æ‰‹åŠ¨å¯åŠ¨ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰
```bash
cd /root/ai_music/ai_music
NODE_ENV=development node index.js
```

---

## ğŸ“ å¿«é€Ÿä¿®å¤å‘½ä»¤æ±‡æ€»

```bash
# ä¿®å¤ä¾èµ–é—®é¢˜
./ä¿®å¤ä¾èµ–.sh

# å®Œå…¨é‡æ–°éƒ¨ç½²
pm2 delete ai-music-service
rm -rf node_modules package-lock.json
npm install
pm2 start ecosystem.config.js
pm2 save

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status
pm2 logs ai-music-service

# æµ‹è¯•æœåŠ¡
curl http://localhost:3001/health
curl http://localhost:3001/
```

---

## âœ… éªŒè¯æœåŠ¡æ­£å¸¸çš„æ ‡å¿—

### 1. PM2 çŠ¶æ€æ­£å¸¸
```bash
$ pm2 status
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ name             â”‚ status  â”‚ restart â”‚ uptime   â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0   â”‚ ai-music-service â”‚ online  â”‚ 0       â”‚ 10s      â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å¥åº·æ£€æŸ¥æˆåŠŸ
```bash
$ curl http://localhost:3001/health
{"status":"ok","timestamp":"...","service":"ai-music-service"}
```

### 3. æ—¥å¿—æ­£å¸¸
```bash
$ pm2 logs ai-music-service --lines 5
ğŸµ AI éŸ³ä¹æœåŠ¡å·²å¯åŠ¨ (v2.0)
ğŸ“¡ ç«¯å£: 3001
âš™ï¸  ä»»åŠ¡ç®¡ç†å™¨: å¹¶å‘=10, é˜Ÿåˆ—=2500
â˜ï¸  OSS: https://ai.mediaio.net/...
```

---

## ğŸ“ é¢„é˜²æªæ–½

1. **éƒ¨ç½²å‰æ£€æŸ¥**
   ```bash
   ./éƒ¨ç½²å‰æ£€æŸ¥.sh
   ```

2. **å®šæœŸå¤‡ä»½**
   ```bash
   cp -r /root/ai_music/ai_music /root/ai_music/ai_music.backup.$(date +%Y%m%d)
   ```

3. **ç›‘æ§æ—¥å¿—**
   ```bash
   pm2 monit
   ```

4. **è®¾ç½®è‡ªåŠ¨é‡å¯**
   ```bash
   pm2 startup
   pm2 save
   ```

