# AI 音乐服务 - 接口测试手册

## 🎯 快速开始

### 1. 启动服务
```bash
cd ai_music_service_deploy
npm run start:all
```

### 2. 运行自动化测试
```bash
node test-complete.js
```

### 3. 查看测试结果
测试将自动执行所有 13 个接口，并显示详细结果。

---

## 📋 13 个接口清单

### ✅ 基础服务 (2)

#### 1. 服务信息
```bash
curl http://localhost:3001/
```

#### 2. 健康检查
```bash
curl http://localhost:3001/health
```

---

### ✅ 任务管理 (1)

#### 3. 获取所有任务
```bash
curl http://localhost:3001/api/music/tasks
```

---

### ✅ 歌词生成 (2)

#### 4. 生成歌词
```bash
curl -X POST http://localhost:3001/api/music/generate-lyrics \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "一首关于城市夜晚的歌"
  }'
```

**响应示例**:
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "taskId": "abc123..."
  }
}
```

#### 5. 查询歌词详情
```bash
curl http://localhost:3001/api/music/lyrics/{taskId}
```

---

### ✅ 文件上传 (2)

#### 6. 上传音频文件
```bash
curl -X POST http://localhost:3001/api/upload/audio \
  -F "audio=@your-audio.mp3"
```

**支持格式**: MP3, WAV, FLAC

#### 7. 获取文件列表
```bash
curl http://localhost:3001/api/upload/list
```

---

### ✅ 音乐生成 (2)

#### 8. 生成音乐 - 简单模式
```bash
curl -X POST http://localhost:3001/api/music/generate \
  -H "Content-Type: application/json" \
  -d '{
    "customMode": false,
    "model": "V5",
    "prompt": "一首轻快的流行歌曲"
  }'
```

#### 9. 生成音乐 - 自定义模式
```bash
curl -X POST http://localhost:3001/api/music/generate \
  -H "Content-Type: application/json" \
  -d '{
    "customMode": true,
    "model": "V5",
    "prompt": "[Verse]\n歌词内容\n[Chorus]\n副歌",
    "title": "我的歌曲",
    "tags": "流行, 轻快"
  }'
```

**参数说明**:
- `customMode`: `false` = 简单模式, `true` = 自定义模式
- `model`: `V3_5`, `V4`, `V4_5`, `V4_5PLUS`, `V5`
- `prompt`: 简单模式=描述，自定义模式=歌词
- `title`: 歌曲标题（自定义模式）
- `tags`: 音乐风格标签（自定义模式）

---

### ✅ 任务查询 (2)

#### 10. 获取任务状态
```bash
curl http://localhost:3001/api/music/task/{taskId}
```

**响应示例**:
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "taskId": "abc123...",
    "status": "pending",
    "created_at": "2025-11-13T10:00:00.000Z"
  }
}
```

**状态值**:
- `pending`: 处理中
- `text`: 歌词已生成
- `first`: 第一版音乐已生成
- `complete`: 完成
- `error`: 失败

#### 11. 获取任务详情（Suno API）
```bash
curl http://localhost:3001/api/music/task/{taskId}/detail
```

---

### ✅ 高级功能 (2)

#### 12. 添加人声
```bash
curl -X POST http://localhost:3001/api/music/add-vocals \
  -H "Content-Type: application/json" \
  -d '{
    "uploadUrl": "https://your-domain.com/uploads/audio.mp3",
    "prompt": "[Verse]\n歌词\n[Chorus]\n副歌",
    "title": "我的歌曲",
    "style": "流行",
    "vocalGender": "f"
  }'
```

**参数说明**:
- `uploadUrl`: 上传的伴奏音频 URL（必需）
- `prompt`: 歌词内容（必需）
- `style`: 音乐风格（必需）
- `vocalGender`: `f` = 女声, `m` = 男声

#### 13. 添加伴奏
```bash
curl -X POST http://localhost:3001/api/music/add-instrumental \
  -H "Content-Type: application/json" \
  -d '{
    "uploadUrl": "https://your-domain.com/uploads/audio.mp3",
    "title": "我的歌曲",
    "tags": "流行, 轻快"
  }'
```

**参数说明**:
- `uploadUrl`: 上传的人声音频 URL（必需）
- `tags`: 音乐风格标签（必需）
- `title`: 歌曲标题

---

## 🔄 完整工作流程示例

### 流程 1: 生成歌词 + 音乐

```bash
# 1. 生成歌词
curl -X POST http://localhost:3001/api/music/generate-lyrics \
  -H "Content-Type: application/json" \
  -d '{"prompt": "一首关于梦想的歌"}'
# 返回: {"data": {"taskId": "lyrics-task-id"}}

# 2. 等待 5-10 秒，查询歌词
curl http://localhost:3001/api/music/lyrics/lyrics-task-id
# 返回: {"data": {"status": "SUCCESS", "response": {"data": [{"text": "..."}]}}}

# 3. 使用生成的歌词创建音乐
curl -X POST http://localhost:3001/api/music/generate \
  -H "Content-Type: application/json" \
  -d '{
    "customMode": true,
    "model": "V5",
    "prompt": "从步骤2获取的歌词",
    "title": "梦想之歌",
    "tags": "流行, 励志"
  }'
# 返回: {"data": {"taskId": "music-task-id"}}

# 4. 轮询查询音乐生成状态
curl http://localhost:3001/api/music/task/music-task-id/detail
# 等待 status 变为 "SUCCESS"
```

### 流程 2: 上传音频 + 添加人声

```bash
# 1. 上传伴奏音频
curl -X POST http://localhost:3001/api/upload/audio \
  -F "audio=@instrumental.mp3"
# 返回: {"data": {"url": "https://..."}}

# 2. 添加人声
curl -X POST http://localhost:3001/api/music/add-vocals \
  -H "Content-Type: application/json" \
  -d '{
    "uploadUrl": "从步骤1获取的URL",
    "prompt": "[Verse]\n歌词内容",
    "title": "完整歌曲",
    "style": "流行",
    "vocalGender": "f"
  }'
# 返回: {"data": {"taskId": "vocals-task-id"}}

# 3. 查询任务状态
curl http://localhost:3001/api/music/task/vocals-task-id/detail
```

---

## 🧪 测试技巧

### 1. 使用 Postman
导入以下环境变量：
```
BASE_URL = http://localhost:3001
FILE_SERVER = http://localhost:8081
```

### 2. 使用 JavaScript
```javascript
const axios = require('axios');

// 生成歌词
const response = await axios.post('http://localhost:3001/api/music/generate-lyrics', {
  prompt: '一首关于测试的歌'
});

console.log('任务ID:', response.data.data.taskId);
```

### 3. 轮询任务状态
```javascript
async function waitForTask(taskId) {
  while (true) {
    const res = await axios.get(`http://localhost:3001/api/music/task/${taskId}/detail`);
    const status = res.data.data.status;
    
    if (status === 'SUCCESS') {
      console.log('完成！', res.data.data.response);
      break;
    } else if (status === 'ERROR') {
      console.error('失败！', res.data.data.errorMessage);
      break;
    }
    
    console.log('等待中...', status);
    await new Promise(resolve => setTimeout(resolve, 3000));
  }
}
```

---

## 📊 测试检查清单

- [ ] 所有 13 个接口都能正常调用
- [ ] 歌词生成任务能成功创建
- [ ] 音乐生成任务能成功创建
- [ ] 文件上传功能正常
- [ ] 任务状态查询正常
- [ ] 添加人声功能正常
- [ ] 添加伴奏功能正常
- [ ] 错误处理正确（如缺少必需参数）
- [ ] 回调地址配置正确
- [ ] 文件服务器能访问上传的文件

---

## 🚨 常见问题

### Q: 测试失败怎么办？
A: 检查服务是否启动：`curl http://localhost:3001/health`

### Q: 任务一直是 PENDING 状态？
A: 检查 ngrok 是否运行，回调地址是否正确配置

### Q: 文件上传失败？
A: 确保文件格式为 MP3/WAV/FLAC，大小不超过限制

### Q: 如何查看详细日志？
A: 查看 `logs/combined.log` 和 `logs/error.log`

---

**最后更新**: 2025-11-13  
**测试状态**: ✅ 所有 13 个接口测试通过

