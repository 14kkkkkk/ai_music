# 🔧 AI 音乐服务 vs AI 视频服务 - 配置对比说明

## 📊 两个服务的关系

这两个服务是**完全独立**的服务，部署在同一台服务器上，但各自独立运行。

| 项目 | 服务名称 | 端口 | 用途 |
|------|---------|------|------|
| `zhu-zongyin-video` | AI 视频处理服务 | 5000 | 图片/视频分析和增强 |
| `ai_music_service_deploy` | AI 音乐生成服务 | 3001 | 音乐生成和处理 |

---

## ⚙️ 配置对比

### 1️⃣ 需要统一的配置（两个服务共享）

| 配置项 | 值 | 说明 |
|--------|-----|------|
| `SERVER_IP` | `47.252.36.81` | 服务器公网 IP |
| `OSS_SIGNED_URL_API` | `https://ai.mediaio.net/api/v1/ai/signed-upload-url` | OSS 签名 URL 接口（✅ 两个服务使用相同接口） |
| `NODE_ENV` | `production` | 生产环境 |

### 2️⃣ 需要独立的配置（各自不同）

#### 视频服务 (zhu-zongyin-video)
```bash
# 服务端口
PORT=5000

# 回调地址
CALLBACK_BASE_URL=http://47.252.36.81:5000

# 文件服务器（视频服务需要）
FILE_SERVER_PORT=8081
FILE_SERVER_BASE_URL=http://47.252.36.81:8081

# 临时文件目录
TEMP_DIR=./temp_frames

# 视频服务专用 API
OPENROUTER_API_KEY=sk-or-v1-...
ARK_API_KEY=ecf29845-...
WAVESPEED_API_KEY=2c9c59c327b0b59b...
```

#### 音乐服务 (ai_music_service_deploy)
```bash
# 服务端口
PORT=3001

# 回调地址
CALLBACK_BASE_URL=http://47.252.36.81:3001

# 临时文件目录
TEMP_DIR=./temp_audio

# 音乐服务专用 API
SUNO_API_KEY=28f61cf2a6012f2a1204f8569768f979
SUNO_API_BASE_URL=https://api.sunoapi.org/api/v1

# 注意：音乐服务不需要文件服务器（直接上传到 OSS）
```

---

## 🚀 PM2 进程管理

### 视频服务进程
```bash
pm2 list
# 应该看到：
# - ai-middleware (端口 5000)
# - file-server (端口 8081)
```

### 音乐服务进程
```bash
pm2 list
# 应该看到：
# - ai-music-service (端口 3001)
# 注意：没有 file-server（音乐服务不需要）
```

---

## 📁 文件服务器说明

### 视频服务 - 需要文件服务器 ✅
**原因**：
- AI 分析视频时需要访问切片后的视频文件
- 文件服务器提供临时访问 URL 给 AI API

**配置**：
- 端口：8081
- 目录：`./temp_frames`
- 访问地址：`http://47.252.36.81:8081`

### 音乐服务 - 不需要文件服务器 ❌
**原因**：
- Suno API 生成的音频文件直接从 Suno 服务器下载
- 下载后立即上传到 OSS
- 不需要提供临时访问 URL

**工作流程**：
```
1. 调用 Suno API 生成音乐
2. 轮询任务状态
3. 从 Suno 下载音频文件到临时目录
4. 计算 MD5 生成文件名
5. 上传到 OSS
6. 删除临时文件
7. 回调后端（只传文件名）
```

---

## 🔐 端口占用情况

| 端口 | 服务 | 说明 |
|------|------|------|
| 5000 | 视频服务主服务 | 图片/视频处理 API |
| 8081 | 视频服务文件服务器 | 提供临时文件访问 |
| 3001 | 音乐服务主服务 | 音乐生成 API |

**防火墙配置**：
```bash
# 需要开放的端口
firewall-cmd --permanent --add-port=5000/tcp
firewall-cmd --permanent --add-port=8081/tcp
firewall-cmd --permanent --add-port=3001/tcp
firewall-cmd --reload
```

---

## 📝 部署检查清单

### 视频服务部署检查
- [ ] `.env` 文件配置正确（PORT=5000）
- [ ] `FILE_SERVER_PORT=8081` 已配置
- [ ] `temp_frames` 目录存在
- [ ] PM2 启动了 2 个进程（主服务 + 文件服务器）
- [ ] 端口 5000 和 8081 可访问

### 音乐服务部署检查
- [ ] `.env` 文件配置正确（PORT=3001）
- [ ] `SUNO_API_KEY` 已配置
- [ ] `temp_audio` 目录存在
- [ ] PM2 启动了 1 个进程（只有主服务）
- [ ] 端口 3001 可访问
- [ ] **确认没有启动 file-server**

---

## 🎯 快速验证

### 验证视频服务
```bash
# 健康检查
curl http://47.252.36.81:5000/health

# 文件服务器检查
curl http://47.252.36.81:8081/
```

### 验证音乐服务
```bash
# 健康检查
curl http://47.252.36.81:3001/health

# 服务信息
curl http://47.252.36.81:3001/
```

---

## ⚠️ 常见问题

### Q1: 两个服务可以共享文件服务器吗？
**A**: 不建议。视频服务的文件服务器是为视频切片设计的，音乐服务不需要文件服务器。

### Q2: OSS 接口是同一个吗？
**A**: 是的，两个服务使用同一个 OSS 签名 URL 接口（`https://ai.mediaio.net/api/v1/ai/signed-upload-url`）。

### Q3: 如何区分两个服务的日志？
**A**: 
- 视频服务日志：`zhu-zongyin-video/logs/`
- 音乐服务日志：`ai_music_service_deploy/logs/`

### Q4: 两个服务会互相影响吗？
**A**: 不会。它们使用不同的端口、不同的临时目录、不同的 API 密钥，完全独立运行。

---

## 📦 部署建议

1. **先部署视频服务**（端口 5000 + 8081）
2. **再部署音乐服务**（端口 3001）
3. **分别测试**各自的功能
4. **监控资源**使用情况（内存、CPU）

---

## 🔄 更新配置后的操作

```bash
# 视频服务
cd /path/to/zhu-zongyin-video
pm2 restart ecosystem.config.js

# 音乐服务
cd /path/to/ai_music_service_deploy
pm2 restart ecosystem.config.js

# 查看所有服务状态
pm2 status
```

