# ğŸš€ AI éŸ³ä¹æœåŠ¡ - éƒ¨ç½²åˆ°æœåŠ¡å™¨æŒ‡å—

## ğŸ“¦ éƒ¨ç½²å‡†å¤‡

### 1. æœåŠ¡å™¨è¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Linux (CentOS/Ubuntu)
- **Node.js**: >= 18.0.0
- **å†…å­˜**: >= 2GB
- **ç£ç›˜**: >= 10GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: å¯è®¿é—®å¤–ç½‘ï¼ˆéœ€è¦è°ƒç”¨ Suno API å’Œ OSSï¼‰

### 2. éœ€è¦å¼€æ”¾çš„ç«¯å£
```bash
# éŸ³ä¹æœåŠ¡ä¸»æœåŠ¡
3001/tcp
```

**æ³¨æ„**: éŸ³ä¹æœåŠ¡ä¸éœ€è¦æ–‡ä»¶æœåŠ¡å™¨ï¼Œæ‰€ä»¥ä¸éœ€è¦å¼€æ”¾ 8081 ç«¯å£ï¼ˆ8081 æ˜¯è§†é¢‘æœåŠ¡çš„æ–‡ä»¶æœåŠ¡å™¨ç«¯å£ï¼‰

---

## ğŸ“ éƒ¨ç½²æ­¥éª¤

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

#### 1. ä¸Šä¼ é¡¹ç›®åˆ°æœåŠ¡å™¨
```bash
# åœ¨æœ¬åœ°æ‰“åŒ…é¡¹ç›®ï¼ˆæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼‰
cd C:\work\ai_music\ai_music_service_deploy
tar -czf ai-music-service.tar.gz \
  --exclude=node_modules \
  --exclude=logs \
  --exclude=temp_audio \
  --exclude=uploads \
  --exclude=test-*.js \
  --exclude=simple-test.js \
  --exclude=*.md \
  .

# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp ai-music-service.tar.gz root@47.252.36.81:/opt/
```

#### 2. åœ¨æœåŠ¡å™¨ä¸Šè§£å‹
```bash
ssh root@47.252.36.81

cd /opt
mkdir -p ai-music-service
tar -xzf ai-music-service.tar.gz -C ai-music-service
cd ai-music-service
```

#### 3. é…ç½®ç¯å¢ƒå˜é‡
```bash
# ç¼–è¾‘ .env æ–‡ä»¶
vim .env

# ç¡®ä¿ä»¥ä¸‹é…ç½®æ­£ç¡®ï¼š
# SERVER_IP=47.252.36.81
# CALLBACK_BASE_URL=http://47.252.36.81:3001
# SUNO_API_KEY=ä½ çš„å¯†é’¥
# OSS_SIGNED_URL_API=https://ai.mediaio.net/api/v1/ai/signed-upload-url
```

#### 4. è¿è¡Œéƒ¨ç½²å‰æ£€æŸ¥
```bash
chmod +x éƒ¨ç½²å‰æ£€æŸ¥.sh
./éƒ¨ç½²å‰æ£€æŸ¥.sh
```

#### 5. ä¸€é”®éƒ¨ç½²
```bash
chmod +x ä¸€é”®éƒ¨ç½².sh
./ä¸€é”®éƒ¨ç½².sh
```

#### 6. éªŒè¯éƒ¨ç½²
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs ai-music-service

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:3001/health

# æµ‹è¯•æœåŠ¡ä¿¡æ¯
curl http://localhost:3001/
```

---

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

#### 1. å®‰è£… Node.js
```bash
# CentOS
curl -sL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs

# Ubuntu
curl -sL https://deb.nodesource.com/setup_18.x | bash -
apt-get install -y nodejs

# éªŒè¯å®‰è£…
node -v
npm -v
```

#### 2. å®‰è£… PM2
```bash
npm install -g pm2
pm2 -v
```

#### 3. ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
```bash
# ä½¿ç”¨ scp æˆ– rsync ä¸Šä¼ æ•´ä¸ªé¡¹ç›®ç›®å½•
rsync -avz --exclude='node_modules' \
  --exclude='logs' \
  --exclude='temp_audio' \
  C:\work\ai_music\ai_music_service_deploy/ \
  root@47.252.36.81:/opt/ai-music-service/
```

#### 4. å®‰è£…ä¾èµ–
```bash
cd /opt/ai-music-service
npm install
```

#### 5. é…ç½®ç¯å¢ƒå˜é‡
```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘é…ç½®
vim .env
```

#### 6. åˆ›å»ºå¿…è¦çš„ç›®å½•
```bash
mkdir -p logs
mkdir -p temp_audio
mkdir -p data
```

#### 7. å¯åŠ¨æœåŠ¡
```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

---

## ğŸ”§ é…ç½®é˜²ç«å¢™

### CentOS/RHEL (firewalld)
```bash
# å¼€æ”¾ç«¯å£
firewall-cmd --permanent --add-port=3001/tcp
firewall-cmd --reload

# éªŒè¯
firewall-cmd --list-ports
```

### Ubuntu (ufw)
```bash
# å¼€æ”¾ç«¯å£
ufw allow 3001/tcp
ufw reload

# éªŒè¯
ufw status
```

---

## âœ… éƒ¨ç½²éªŒè¯

### 1. æ£€æŸ¥è¿›ç¨‹
```bash
pm2 status

# åº”è¯¥çœ‹åˆ°ï¼š
# â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ id  â”‚ name             â”‚ status  â”‚ restart â”‚ uptime   â”‚
# â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ 0   â”‚ ai-music-service â”‚ online  â”‚ 0       â”‚ 10s      â”‚
# â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ³¨æ„**: åªåº”è¯¥æœ‰ 1 ä¸ªè¿›ç¨‹ï¼ˆai-music-serviceï¼‰ï¼Œä¸åº”è¯¥æœ‰ file-server è¿›ç¨‹ã€‚

### 2. æ£€æŸ¥æ—¥å¿—
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs ai-music-service

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# ğŸµ AI éŸ³ä¹æœåŠ¡å·²å¯åŠ¨ (v2.0)
# ğŸ“¡ ç«¯å£: 3001
# âš™ï¸  ä»»åŠ¡ç®¡ç†å™¨: å¹¶å‘=10, é˜Ÿåˆ—=2500
# â˜ï¸  OSS: https://ai.mediaio.net/api/v1/ai/signed-upload-url
```

### 3. æµ‹è¯•æ¥å£
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3001/health
# é¢„æœŸè¾“å‡º: {"status":"ok","timestamp":"...","service":"ai-music-service"}

# æœåŠ¡ä¿¡æ¯
curl http://localhost:3001/
# é¢„æœŸè¾“å‡º: åŒ…å«ç‰ˆæœ¬å·ã€ç«¯ç‚¹åˆ—è¡¨ç­‰

# ä»»åŠ¡ç»Ÿè®¡
curl http://localhost:3001/api/music/stats
# é¢„æœŸè¾“å‡º: {"total":0,"pending":0,"processing":0,...}
```

### 4. æµ‹è¯•å¤–ç½‘è®¿é—®
```bash
# ä»æœ¬åœ°æµ‹è¯•
curl http://47.252.36.81:3001/health
```

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### æ›´æ–°ä»£ç 
```bash
# 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
cd /opt
cp -r ai-music-service ai-music-service.backup.$(date +%Y%m%d)

# 2. ä¸Šä¼ æ–°ä»£ç 
# ï¼ˆä½¿ç”¨ scp æˆ– rsyncï¼‰

# 3. å®‰è£…æ–°ä¾èµ–ï¼ˆå¦‚æœæœ‰ï¼‰
cd /opt/ai-music-service
npm install

# 4. é‡å¯æœåŠ¡
pm2 restart ai-music-service

# 5. æŸ¥çœ‹æ—¥å¿—
pm2 logs ai-music-service
```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```bash
pm2 status
pm2 monit  # å®æ—¶ç›‘æ§
```

### æŸ¥çœ‹æ—¥å¿—
```bash
pm2 logs ai-music-service          # å®æ—¶æ—¥å¿—
pm2 logs ai-music-service --lines 100  # æœ€è¿‘ 100 è¡Œ
tail -f logs/combined.log          # åº”ç”¨æ—¥å¿—
tail -f logs/error.log             # é”™è¯¯æ—¥å¿—
```

### é‡å¯æœåŠ¡
```bash
pm2 restart ai-music-service
```

### åœæ­¢æœåŠ¡
```bash
pm2 stop ai-music-service
```

### åˆ é™¤æœåŠ¡
```bash
pm2 delete ai-music-service
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ç«¯å£ 3001 è¢«å ç”¨
```bash
# æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹
netstat -tuln | grep 3001
lsof -i :3001

# æ€æ­»è¿›ç¨‹
kill -9 <PID>
```

### Q2: PM2 å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
pm2 logs ai-music-service --err

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat .env

# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
node index.js
```

### Q3: OSS ä¸Šä¼ å¤±è´¥
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
curl https://ai.mediaio.net/api/v1/ai/signed-upload-url?fileName=test.mp3

# æ£€æŸ¥é…ç½®
grep OSS_SIGNED_URL_API .env
```

### Q4: å†…å­˜ä¸è¶³
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
pm2 monit

# è°ƒæ•´ PM2 é…ç½®
# ç¼–è¾‘ ecosystem.config.js
# max_memory_restart: '1G'  # æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
```

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å®Œæˆåï¼Œè¯·ç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] Node.js ç‰ˆæœ¬ >= 18.0.0
- [ ] PM2 å·²å®‰è£…å¹¶é…ç½®å¼€æœºè‡ªå¯
- [ ] .env æ–‡ä»¶é…ç½®æ­£ç¡®
- [ ] ç«¯å£ 3001 å·²å¼€æ”¾
- [ ] åªæœ‰ 1 ä¸ª PM2 è¿›ç¨‹ï¼ˆai-music-serviceï¼‰
- [ ] æ²¡æœ‰ file-server è¿›ç¨‹
- [ ] å¥åº·æ£€æŸ¥æ¥å£è¿”å›æ­£å¸¸
- [ ] æœåŠ¡ä¿¡æ¯æ¥å£è¿”å›æ­£å¸¸
- [ ] å¤–ç½‘å¯ä»¥è®¿é—®æœåŠ¡
- [ ] æ—¥å¿—æ­£å¸¸è¾“å‡º
- [ ] temp_audio ç›®å½•å­˜åœ¨ä¸”å¯å†™

---

## ğŸ¯ ä¸‹ä¸€æ­¥

éƒ¨ç½²å®Œæˆåï¼Œå»ºè®®ï¼š

1. **æµ‹è¯•å®Œæ•´æµç¨‹**ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬æµ‹è¯•éŸ³ä¹ç”ŸæˆåŠŸèƒ½
2. **é…ç½®ç›‘æ§**ï¼šè®¾ç½®æœåŠ¡ç›‘æ§å’Œå‘Šè­¦
3. **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶å’Œæ•°æ®
4. **æ–‡æ¡£æ›´æ–°**ï¼šè®°å½•éƒ¨ç½²è¿‡ç¨‹ä¸­çš„ç‰¹æ®Šé…ç½®

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- `æœåŠ¡é…ç½®å¯¹æ¯”è¯´æ˜.md` - äº†è§£ä¸è§†é¢‘æœåŠ¡çš„åŒºåˆ«
- `APIæ¥å£æ–‡æ¡£-ä¾›ä¸­å°å’Œå‰ç«¯è°ƒç”¨.md` - API ä½¿ç”¨è¯´æ˜
- `å‡çº§è¯´æ˜.md` - v2.0 å‡çº§è¯¦æƒ…

