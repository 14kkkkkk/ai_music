# 部署检查清单

## ✅ 部署前检查

### 1. 配置文件检查

- [ ] `.env` 文件已配置
  - [x] `SUNO_API_KEY=28f61cf2a6012f2a1204f8569768f979`
  - [x] `CALLBACK_BASE_URL=http://47.252.36.81:8081`
  - [x] `PORT=3001`
  - [x] `FILE_SERVER_PORT=8081`

### 2. 服务器环境检查

- [ ] Node.js 已安装（版本 >= 18.0.0）
  ```bash
  node --version
  ```

- [ ] npm 已安装
  ```bash
  npm --version
  ```

- [ ] PM2 已安装（可选，推荐）
  ```bash
  npm install -g pm2
  ```

### 3. 网络配置检查

- [ ] 服务器防火墙已开放 3001 端口
  ```bash
  # Ubuntu/Debian
  sudo ufw allow 3001/tcp
  
  # CentOS/RHEL
  sudo firewall-cmd --permanent --add-port=3001/tcp
  sudo firewall-cmd --reload
  ```

- [ ] 服务器防火墙已开放 8081 端口
  ```bash
  # Ubuntu/Debian
  sudo ufw allow 8081/tcp
  
  # CentOS/RHEL
  sudo firewall-cmd --permanent --add-port=8081/tcp
  sudo firewall-cmd --reload
  ```

- [ ] 云服务器安全组已配置
  - [ ] 入站规则：允许 TCP 3001
  - [ ] 入站规则：允许 TCP 8081

---

## 📦 部署步骤

### 步骤 1: 上传文件

```bash
# 方式 1: 使用 SCP
scp -r ai_music_service_deploy root@47.252.36.81:/root/

# 方式 2: 使用 tar 打包后上传
tar -czf ai_music_service.tar.gz ai_music_service_deploy/
scp ai_music_service.tar.gz root@47.252.36.81:/root/
```

- [ ] 文件已上传到服务器

### 步骤 2: 解压和安装

```bash
# SSH 登录服务器
ssh root@47.252.36.81

# 如果是 tar 包，先解压
cd /root
tar -xzf ai_music_service.tar.gz

# 进入目录
cd ai_music_service_deploy

# 安装依赖
npm install --production
```

- [ ] 依赖已安装完成

### 步骤 3: 启动服务

```bash
# 使用 PM2 启动（推荐）
npm run pm2:start

# 或使用普通方式启动
npm run start:all
```

- [ ] 服务已启动

---

## ✅ 部署后验证

### 1. 检查服务状态

```bash
# 检查 PM2 状态
npm run pm2:status

# 应该看到两个服务都在运行：
# - ai-music-service (online)
# - ai-music-file-server (online)
```

- [ ] 主服务运行正常
- [ ] 文件服务器运行正常

### 2. 测试健康检查

```bash
# 在服务器上测试
curl http://localhost:3001/health

# 在本地测试（替换为你的服务器 IP）
curl http://47.252.36.81:3001/health
```

**期望响应**:
```json
{
  "status": "ok",
  "timestamp": "2025-11-13T10:00:00.000Z",
  "uptime": 100
}
```

- [ ] 健康检查通过

### 3. 测试文件服务器

```bash
curl http://47.252.36.81:8081/health
```

- [ ] 文件服务器响应正常

### 4. 测试 API 接口

```bash
# 测试生成歌词
curl -X POST http://47.252.36.81:3001/api/music/generate-lyrics \
  -H "Content-Type: application/json" \
  -d '{"prompt": "一首关于测试的歌"}'
```

**期望响应**:
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "taskId": "xxx..."
  }
}
```

- [ ] API 接口响应正常

### 5. 运行完整测试（可选）

```bash
cd /root/ai_music_service_deploy
node test-complete.js
```

- [ ] 所有测试通过（13/13）

---

## 📊 监控检查

### 1. 查看日志

```bash
# 查看 PM2 日志
npm run pm2:logs

# 查看文件日志
tail -f logs/combined.log
tail -f logs/error.log
```

- [ ] 日志正常，无错误

### 2. 检查资源使用

```bash
# 查看 PM2 监控
pm2 monit

# 查看系统资源
top
htop
```

- [ ] CPU 使用率正常
- [ ] 内存使用率正常

---

## 🔧 常见问题排查

### 问题 1: 端口被占用

```bash
# 查看端口占用
netstat -tlnp | grep 3001
netstat -tlnp | grep 8081

# 杀死占用进程
kill -9 <PID>
```

### 问题 2: 无法从外网访问

1. 检查防火墙配置
2. 检查云服务器安全组
3. 检查服务是否绑定到 0.0.0.0

### 问题 3: 回调不工作

1. 确认 `CALLBACK_BASE_URL` 配置正确
2. 确认 8081 端口可以从外网访问
3. 检查 Suno API 是否能访问回调地址

---

## 📝 部署完成确认

### 最终检查清单

- [ ] 所有配置文件已正确配置
- [ ] 服务已成功启动
- [ ] 健康检查通过
- [ ] API 接口测试通过
- [ ] 防火墙和安全组已配置
- [ ] 日志正常，无错误
- [ ] 文档已更新（如有需要）

### 服务信息记录

- **服务器 IP**: `47.252.36.81`
- **主服务地址**: `http://47.252.36.81:3001`
- **文件服务地址**: `http://47.252.36.81:8081`
- **API Key**: `28f61cf2a6012f2a1204f8569768f979`
- **部署时间**: _______________
- **部署人员**: _______________

---

## 🎉 部署成功！

如果所有检查项都已完成，恭喜你！服务已成功部署。

### 下一步

1. 将 API 文档分享给前端/中台开发者
2. 配置监控和告警（可选）
3. 设置定期备份（可选）
4. 配置 HTTPS（可选，推荐）

### 相关文档

- **API 文档**: `API接口文档-供中台和前端调用.md`
- **快速参考**: `API快速参考卡片.md`
- **运维指南**: `AI音乐服务-部署指南.md`
- **服务器配置**: `服务器配置说明.md`

---

**检查清单版本**: v1.0.0  
**最后更新**: 2025-11-13

