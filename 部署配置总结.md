# ğŸµ AI éŸ³ä¹æœåŠ¡ - éƒ¨ç½²é…ç½®æ€»ç»“

## ğŸ“‹ é¡¹ç›®ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **é¡¹ç›®åç§°** | AI éŸ³ä¹æœåŠ¡ (ai-music-service) |
| **ç‰ˆæœ¬** | v2.0 |
| **æœåŠ¡ç«¯å£** | 3001 |
| **æœåŠ¡å™¨ IP** | 47.252.36.81 |
| **éƒ¨ç½²è·¯å¾„** | /opt/ai-music-service |

---

## âš™ï¸ ç¯å¢ƒå˜é‡é…ç½® (.env)

```bash
# ============================================
# AI éŸ³ä¹æœåŠ¡é…ç½®æ–‡ä»¶
# ============================================

# Suno API é…ç½®
SUNO_API_KEY=28f61cf2a6012f2a1204f8569768f979
SUNO_API_BASE_URL=https://api.sunoapi.org/api/v1

# æœåŠ¡é…ç½®
PORT=3001
NODE_ENV=production

# æœåŠ¡å™¨ IP é…ç½®
SERVER_IP=47.252.36.81
CALLBACK_BASE_URL=http://47.252.36.81:3001

# ä»»åŠ¡ç®¡ç†å™¨é…ç½®
MAX_CONCURRENCY=10
MAX_QUEUE_SIZE=2500

# OSS é…ç½®
OSS_SIGNED_URL_API=https://ai.mediaio.net/api/v1/ai/signed-upload-url
OSS_UPLOAD_TIMEOUT=60000

# å›è°ƒé…ç½®
CALLBACK_TIMEOUT=10000

# ä¸´æ—¶æ–‡ä»¶ç›®å½•
TEMP_DIR=./temp_audio

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_DIR=logs
```

---

## ğŸ”§ ä¸è§†é¢‘æœåŠ¡çš„åŒºåˆ«

### éŸ³ä¹æœåŠ¡ (ai_music_service_deploy)
- âœ… **ç«¯å£**: 3001
- âœ… **ä¸´æ—¶ç›®å½•**: temp_audio
- âœ… **API**: Suno API
- âŒ **æ–‡ä»¶æœåŠ¡å™¨**: ä¸éœ€è¦ï¼ˆç›´æ¥ä¸Šä¼ åˆ° OSSï¼‰
- âœ… **PM2 è¿›ç¨‹æ•°**: 1 ä¸ªï¼ˆåªæœ‰ä¸»æœåŠ¡ï¼‰

### è§†é¢‘æœåŠ¡ (zhu-zongyin-video)
- âœ… **ç«¯å£**: 5000
- âœ… **ä¸´æ—¶ç›®å½•**: temp_frames
- âœ… **API**: OpenRouter, ARK, WaveSpeed
- âœ… **æ–‡ä»¶æœåŠ¡å™¨**: éœ€è¦ï¼ˆç«¯å£ 8081ï¼‰
- âœ… **PM2 è¿›ç¨‹æ•°**: 2 ä¸ªï¼ˆä¸»æœåŠ¡ + æ–‡ä»¶æœåŠ¡å™¨ï¼‰

---

## ğŸ“ ç›®å½•ç»“æ„

```
ai_music_service_deploy/
â”œâ”€â”€ index.js                          # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ package.json                      # ä¾èµ–é…ç½®
â”œâ”€â”€ ecosystem.config.js               # PM2 é…ç½®ï¼ˆåªæœ‰ 1 ä¸ªè¿›ç¨‹ï¼‰
â”œâ”€â”€ .env                              # ç¯å¢ƒå˜é‡
â”œâ”€â”€ .env.example                      # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ services/                         # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ taskManager.js               # ä»»åŠ¡ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”œâ”€â”€ ossService.js                # OSS ä¸Šä¼ æœåŠ¡
â”‚   â”œâ”€â”€ callbackService.js           # å›è°ƒæœåŠ¡
â”‚   â””â”€â”€ sunoApi.js                   # Suno API å®¢æˆ·ç«¯
â”œâ”€â”€ routes/                           # è·¯ç”±å±‚
â”‚   â”œâ”€â”€ music.js                     # éŸ³ä¹ç›¸å…³è·¯ç”±
â”‚   â””â”€â”€ callback.js                  # å›è°ƒè·¯ç”±
â”œâ”€â”€ types/                            # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ task.js                      # ä»»åŠ¡ç±»å‹
â”œâ”€â”€ utils/                            # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ logger.js                    # æ—¥å¿—å·¥å…·
â”œâ”€â”€ logs/                             # æ—¥å¿—ç›®å½•
â”œâ”€â”€ temp_audio/                       # ä¸´æ—¶éŸ³é¢‘æ–‡ä»¶
â”œâ”€â”€ data/                             # æ•°æ®å­˜å‚¨
â”œâ”€â”€ ä¸€é”®éƒ¨ç½².sh                       # éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ éƒ¨ç½²å‰æ£€æŸ¥.sh                     # æ£€æŸ¥è„šæœ¬
â”œâ”€â”€ æ‰“åŒ…éƒ¨ç½².bat                      # Windows æ‰“åŒ…è„šæœ¬
â””â”€â”€ éƒ¨ç½²åˆ°æœåŠ¡å™¨æŒ‡å—.md               # éƒ¨ç½²æ–‡æ¡£
```

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. æœ¬åœ°æ‰“åŒ…
```bash
# Windows
æ‰“åŒ…éƒ¨ç½².bat

# ç”Ÿæˆæ–‡ä»¶: ai-music-service-YYYYMMDD_HHMMSS.zip
```

### 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
```bash
scp ai-music-service-*.zip root@47.252.36.81:/opt/
```

### 3. æœåŠ¡å™¨è§£å‹
```bash
ssh root@47.252.36.81
cd /opt
unzip ai-music-service-*.zip -d ai-music-service
cd ai-music-service
```

### 4. é…ç½®ç¯å¢ƒå˜é‡
```bash
# æ£€æŸ¥ .env æ–‡ä»¶
cat .env

# å¦‚éœ€ä¿®æ”¹
vim .env
```

### 5. è¿è¡Œéƒ¨ç½²å‰æ£€æŸ¥
```bash
chmod +x éƒ¨ç½²å‰æ£€æŸ¥.sh
./éƒ¨ç½²å‰æ£€æŸ¥.sh
```

### 6. ä¸€é”®éƒ¨ç½²
```bash
chmod +x ä¸€é”®éƒ¨ç½².sh
./ä¸€é”®éƒ¨ç½².sh
```

### 7. éªŒè¯éƒ¨ç½²
```bash
# æŸ¥çœ‹è¿›ç¨‹ï¼ˆåº”è¯¥åªæœ‰ 1 ä¸ªï¼‰
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs ai-music-service

# æµ‹è¯•æ¥å£
curl http://localhost:3001/health
curl http://47.252.36.81:3001/health
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰
- [ ] å·²å®‰è£… Node.js >= 18.0.0
- [ ] å·²å®‰è£… PM2
- [ ] ç«¯å£ 3001 æœªè¢«å ç”¨
- [ ] é˜²ç«å¢™å·²å¼€æ”¾ 3001 ç«¯å£
- [ ] .env æ–‡ä»¶é…ç½®æ­£ç¡®

### éƒ¨ç½²å
- [ ] PM2 åªæœ‰ 1 ä¸ªè¿›ç¨‹ï¼ˆai-music-serviceï¼‰
- [ ] æ²¡æœ‰ file-server è¿›ç¨‹
- [ ] æœåŠ¡çŠ¶æ€ä¸º online
- [ ] å¥åº·æ£€æŸ¥æ¥å£è¿”å›æ­£å¸¸
- [ ] å¤–ç½‘å¯ä»¥è®¿é—®æœåŠ¡
- [ ] æ—¥å¿—æ­£å¸¸è¾“å‡º
- [ ] temp_audio ç›®å½•å­˜åœ¨

---

## ğŸ” ç«¯å£å’Œé˜²ç«å¢™

### éœ€è¦å¼€æ”¾çš„ç«¯å£
```bash
# CentOS/RHEL
firewall-cmd --permanent --add-port=3001/tcp
firewall-cmd --reload

# Ubuntu
ufw allow 3001/tcp
ufw reload
```

### ä¸éœ€è¦å¼€æ”¾çš„ç«¯å£
- âŒ 8081 (æ–‡ä»¶æœåŠ¡å™¨ - éŸ³ä¹æœåŠ¡ä¸éœ€è¦)

---

## ğŸ“Š PM2 é…ç½®

### ecosystem.config.js
```javascript
module.exports = {
  apps: [
    {
      name: 'ai-music-service',
      script: './index.js',
      instances: 1,
      exec_mode: 'cluster',
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
      env: {
        NODE_ENV: 'production',
        PORT: 3001
      },
      error_file: './logs/pm2-error.log',
      out_file: './logs/pm2-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
      merge_logs: true,
      min_uptime: '10s',
      max_restarts: 10,
      restart_delay: 4000,
      kill_timeout: 5000,
      wait_ready: true,
      listen_timeout: 10000
    }
  ]
};
```

**æ³¨æ„**: åªæœ‰ 1 ä¸ªåº”ç”¨é…ç½®ï¼Œæ²¡æœ‰ file-serverã€‚

---

## ğŸŒ API ç«¯ç‚¹

### åŸºç¡€æ¥å£
- `GET /health` - å¥åº·æ£€æŸ¥
- `GET /` - æœåŠ¡ä¿¡æ¯
- `GET /api/music/stats` - ä»»åŠ¡ç»Ÿè®¡

### éŸ³ä¹ç”Ÿæˆæ¥å£
- `POST /api/music/generate-lyrics` - ç”Ÿæˆæ­Œè¯
- `POST /api/music/generate` - ç”ŸæˆéŸ³ä¹
- `POST /api/music/add-vocals` - æ·»åŠ äººå£°
- `GET /api/music/task/:taskId` - æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

### å›è°ƒæ¥å£
- `POST /api/callback/music` - æ¥æ”¶ Suno å›è°ƒ

---

## ğŸ“ å¸¸ç”¨å‘½ä»¤

### PM2 ç®¡ç†
```bash
pm2 start ecosystem.config.js    # å¯åŠ¨
pm2 stop ai-music-service        # åœæ­¢
pm2 restart ai-music-service     # é‡å¯
pm2 delete ai-music-service      # åˆ é™¤
pm2 logs ai-music-service        # æŸ¥çœ‹æ—¥å¿—
pm2 status                       # æŸ¥çœ‹çŠ¶æ€
pm2 monit                        # å®æ—¶ç›‘æ§
```

### æ—¥å¿—æŸ¥çœ‹
```bash
pm2 logs ai-music-service                    # PM2 æ—¥å¿—
tail -f logs/combined.log                    # åº”ç”¨æ—¥å¿—
tail -f logs/error.log                       # é”™è¯¯æ—¥å¿—
tail -f logs/pm2-out.log                     # PM2 è¾“å‡ºæ—¥å¿—
tail -f logs/pm2-error.log                   # PM2 é”™è¯¯æ—¥å¿—
```

### æœåŠ¡æµ‹è¯•
```bash
curl http://localhost:3001/health            # æœ¬åœ°æµ‹è¯•
curl http://47.252.36.81:3001/health         # å¤–ç½‘æµ‹è¯•
curl http://localhost:3001/api/music/stats   # ç»Ÿè®¡ä¿¡æ¯
```

---

## âš ï¸ é‡è¦æé†’

1. **ä¸è¦å¯åŠ¨æ–‡ä»¶æœåŠ¡å™¨**: éŸ³ä¹æœåŠ¡ä¸éœ€è¦ file-server.js
2. **ç«¯å£é…ç½®**: ç¡®ä¿ä½¿ç”¨ 3001 ç«¯å£ï¼Œä¸è¦ä¸è§†é¢‘æœåŠ¡çš„ 5000 ç«¯å£å†²çª
3. **OSS é…ç½®**: ç¡®ä¿ OSS_SIGNED_URL_API å¯è®¿é—®
4. **ä¸´æ—¶ç›®å½•**: ä½¿ç”¨ temp_audioï¼Œä¸æ˜¯ temp_frames
5. **PM2 è¿›ç¨‹**: åªåº”è¯¥æœ‰ 1 ä¸ªè¿›ç¨‹ï¼Œä¸æ˜¯ 2 ä¸ª

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs ai-music-service --err

# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
node index.js

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tuln | grep 3001
```

### OSS ä¸Šä¼ å¤±è´¥
```bash
# æµ‹è¯• OSS æ¥å£
curl "https://ai.mediaio.net/api/v1/ai/signed-upload-url?fileName=test.mp3"

# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping ai.mediaio.net
```

### å†…å­˜ä¸è¶³
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
pm2 monit
free -h

# è°ƒæ•´ max_memory_restart
vim ecosystem.config.js
```

---

## ğŸ¯ éƒ¨ç½²å®Œæˆæ ‡å¿—

å½“ä½ çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºæ—¶ï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸï¼š

```bash
$ pm2 status
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ name             â”‚ status  â”‚ restart â”‚ uptime   â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0   â”‚ ai-music-service â”‚ online  â”‚ 0       â”‚ 10s      â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

$ curl http://localhost:3001/health
{"status":"ok","timestamp":"2025-01-17T...","service":"ai-music-service"}
```

**æ³¨æ„**: åªæœ‰ 1 ä¸ªè¿›ç¨‹ï¼ŒçŠ¶æ€ä¸º onlineã€‚

